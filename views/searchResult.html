<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="public/css/bootstrap.css"/>
    <link rel="stylesheet" href="public/css/index.css"/>
    <link rel="stylesheet" href="public/css/product.css"/>
<!--    <script src="public/js/jquery.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="public/js/popper.min.js"></script>
    <script src="public/js/bootstrap.min.js"></script>
    <script charset="UTF-8">
        let keyword = null;
        let labels = null;
        $(document).ready(function(){
            //鼠标悬停触发事件
            $("#hover_dropdown").hover(function(){
                $(".dropdown-toggle").dropdown('toggle');
            });

            //获取网页链接url所带参数，用于判定页面内容：1.显示所有图书  2.显示关键字搜索结果
            let uri = decodeURI(window.location.href);
            // (function ($) {
            //     $.getUrlParam = function (name) {
            //         let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            //         let r = window.location.search.substr(1).match(reg);
            //         if (r != null)
            //             return unescape(r[2]);
            //         return null;
            //     }
            // })(jQuery);
            // let keyword = $.getUrlParam('keyword');
            keyword = uri.split('=')[1];
            //console.log(keyword);
            if(keyword == null) {
                showAllBooks();
            } else{
                showOnePage(1, {'keyword':keyword, 'labels':null});
            }

            //搜索栏
            $("#searchBtn").click(function(){
                let keyword = $("#keyword").val();
                if(keyword == ''){
                    alert('请输入需要搜索的关键字！');
                }else {
                    $(location).attr('href', encodeURI('http://localhost:8080/searchResult.html?keyword=' + keyword));
                }
            });

            //按标签筛选图书
            $("#submitBtn").click(function(){
                labels = [];
                $("input:checkbox:checked").each(function (){
                    labels.push($(this).val());
                });
                if(labels.length == 0)
                    labels = null;
                showOnePage(1, {'keyword':keyword,'labels':labels});
            });
        });

        //书库：显示所有图书
        function showAllBooks() {
            showOnePage(1, {'keyword':null, 'labels':null});
        }

        //显示1页内容，具体执行哪种查询由参数data内的keyword和labels决定
        function showOnePage(pageNo, data) {
            if(data.keyword != null && data.labels == null){
                $.ajax({
                    method: 'GET',
                    data: {
                        'p': pageNo,
                        'key' : keyword
                    },
                    url: 'http://127.0.0.1:8080/book/searchByKey',
                    success: function (data){
                        fillPanel(data, pageNo);
                    }
                });
            }
            else if(data.keyword == null && data.labels != null){
                $.ajax({
                    method: 'GET',
                    data: {
                        'p': pageNo,
                        'tagList' : data.labels.join()
                    },
                    url: 'http://127.0.0.1:8080/book/searchByTags',
                    success: function (data){
                        fillPanel(data, pageNo);
                    }
                });
            }
            else if(data.keyword == null && data.labels == null){
                $.ajax({
                    method: 'GET',
                    data: {
                        'p': pageNo
                    },
                    url: 'http://127.0.0.1:8080/book/findAll',
                    success: function (data){
                        fillPanel(data, pageNo);
                    }
                });
            }else if(data.keyword != null && data.labels != null){
                $.ajax({
                    method: 'GET',
                    data: {
                        'p': pageNo,
                        'key': data.keyword,
                        'tagList': data.labels.join()
                    },
                    url: 'http://127.0.0.1:8080/book/searchByTagsAndKeys',
                    success: function (data){
                        fillPanel(data, pageNo);
                    }
                });
            }
        }

        function addPaginationBar(bookNum, pageNo) {
            let pageNum = Math.ceil(bookNum / 18);
            let paginationBar = '';
            if(pageNo != 1) {
                paginationBar = "<li class='page-item'>\n" +
                    "                <a id=\"prevBtn\" href='#' class=\"page-link\" aria-label=\"Previous\" onclick='change2PrevPage(this)'>\n" +
                    "                    <span aria-hidden=\"true\">&laquo;</span>\n" +
                    "                </a>\n" +
                    "            </li>";
            }
            for(let i = 1; i < pageNum + 1; i++){
                paginationBar += "<li class='page-item ";
                if(i == pageNo) {
                    paginationBar += "active";
                }
                paginationBar += "'><a class='page-link' href='#' onclick='changePage(this)'>" + i + "</a></li>";
            }
            if(pageNo != pageNum && pageNum != 0){
                paginationBar += "<li class='page-item'>\n" +
                    "                <a id=\"nextBtn\" href='#' class=\"page-link\" aria-label=\"Next\" onclick='change2NextPage(this)'>\n" +
                    "                    <span aria-hidden=\"true\">&raquo;</span>\n" +
                    "                </a>\n" +
                    "            </li>";
            }
            $(".pagination").html(paginationBar);
        }

        function changePage(obj) {
            let pageNo = $(obj).text();
            //console.log(pageNo);
            showOnePage(pageNo, {'keyword':keyword, 'labels':labels});
        }

        function change2PrevPage(obj) {
            let prevPage = $(obj).parents(".pagination").find(".active").prev();
            changePage(prevPage);
        }

        function change2NextPage(obj) {
            let nextPage = $(obj).parents(".pagination").find(".active").next();
            changePage(nextPage);
        }

        function fillPanel(data, pageNo){
            let books = '<div class="row">';
            for(let i = 0; i < data.list.length; i++){
                books += '<div class="col-md-4">\n' +
                    '                <div class="card mb-4 shadow-sm">\n' +
                    '                    <img src="/public/img/bookCover/' + data.list[i].bUri + '" alt="" class="book-img">\n' +
                    '                    <div class="card-body-book">\n' +
                    '                        <div class="book-info">\n' +
                    '                            <p hidden="hidden">' + data.list[i].bId + '</p>\n' +
                    '                            <p class="book-title">' + data.list[i].bName + '</p>\n' +
                    '                            <p class="book-author">' + data.list[i].bAuthor + '</p>\n' +
                    '                        </div>\n' +
                    '                        <div class="d-flex justify-content-between align-items-center">\n' +
                    '                            <div class="btn-group">\n' +
                    '                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="watchDetail(this)">查看</button>\n' +
                    '                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCart(this)">加入购物车</button>\n' +
                    '                            </div>\n' +
                    '                        </div>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </div>'
            }
            books += '</div>';
            $("#bookDisplayPanel").html(books);
            addPaginationBar(data.total, pageNo);
        }
    </script>
</head>
<body>
<div class="container">
    <!-- 顶部信息栏 -->
    <div class="row clearfix sticky-top">
        <div class="col-12">
            <ul class="breadcrumb justify-content-end">
                <li class="breadcrumb-item">
                    欢迎光临xx书店，请先<a href="view/login.html">登录</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="view/regist.html">注册</a>
                </li>
                <li class="breadcrumb-item">
                    <div class="dropdown" id="hover_dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">我</a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#">账户信息</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">我的购物车</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">我的订单</a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li class="breadcrumb-item">
                    <a href="#">联系客服</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 网站logo + 搜索框 + 购物车按钮 -->
    <div class="row">
        <div class="col-lg-3 col-md-12">
            <a href="http://127.0.0.1:8080/index.html" class="navbar-brand"><img src="../public/img/logo.png" alt=""/></a>
        </div>
        <div class="col-lg-5 col-md-12 mt-3">
            <div class="input-group">
                <!--                <img src="img/header/search.png" alt=""/>-->
                <input type="text" id="keyword" class="form-control pt-0 pb-0" placeholder="请输入书籍名称、作者或出版社"/>
                <input type="button" id="searchBtn" value="搜索" />
            </div>
        </div>
        <!-- 带图标的按钮 -->
        <div class="col-lg-4 col-md-12 p-0 mt-3">
            <!--                <a href="#" class="btn btn-lg red">-->
            <!--                    <span class="fa fa-unlock-alt fa-2x"></span>我的购物车-->
            <!--                </a>-->
            <a href="#" class="btn btn-outline-danger btn-lg"><i class="glyphicon glyphicon-shopping-cart"></i> 我的购物车</a>
        </div>
    </div>

    <!-- 筛选标签,
         书本类别可选标签：动漫、经济学、教育、历史、小说、编程、散文、旅行、推理 -->
    <div class="panel-group" id="panel">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a class="panel-title collapsed text-muted" data-toggle="collapse" data-parent="#panel" href="#panel-element">筛选图书类型<span class="fa-caret-down"></span></a>
            </div>
            <div id="panel-element" class="panel-collapse collapse">
                <div class="panel-body">
                    <div>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox1" value="动漫"> 动漫
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox2" value="经济学"> 经济学
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox3" value="教育"> 教育
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox4" value="历史"> 历史
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox5" value="小说"> 小说
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox6" value="编程"> 编程
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox7" value="散文"> 散文
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox8" value="旅行"> 旅行
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" id="inlineCheckbox9" value="推理"> 推理
                        </label>
                        <label class="checkbox-inline pull-right">
                            <input type="submit" id="submitBtn" value="确认">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分割线 -->
    <hr color="#ffffff" />

    <!-- 书库/搜索结果展示区 -->
    <div class="container" id="bookDisplayPanel"></div>
    <!-- 分页栏 -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
<!--            <li>-->
<!--                <a href="#" aria-label="Previous">-->
<!--                    <span aria-hidden="true">&laquo;</span>-->
<!--                </a>-->
<!--            </li>-->
<!--            <li><a href="#">1</a></li>-->
<!--            <li>-->
<!--                <a href="#" aria-label="Next">-->
<!--                    <span aria-hidden="true">&raquo;</span>-->
<!--                </a>-->
<!--            </li>-->
        </ul>
    </nav>

    <!-- 分割线 -->
    <hr color="#ffffff" />

    <!-- 底部footer -->
    <ul class="list-unstyled d-flex justify-content-around" id="footer_upper">
        <li>
            <img src="../public/img/zhengpin.png" alt=""/>
            <p>正规渠道，正品保障</p>
        </li>
        <li>
            <img src="../public/img/peisong.png" alt=""/>
            <p>多仓直发，极速配送</p>
        </li>
        <li>
            <img src="../public/img/huodaofukuan.png" alt=""/>
            <p>放心购物，货到付款</p>
        </li>
        <li>
            <img src="../public/img/pinleiqiquan.png" alt=""/>
            <p>品类齐全，轻松购物</p>
        </li>
    </ul>
    <footer>
        <div class="row">
            <!--6个ul-->
            <div class="col-2">
                <h6 class="text-center">购物指南</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">购物流程</a></li>
                    <li class="text-center"><a href="" class="text-muted">常见问题</a></li>
                    <li class="text-center"><a href="" class="text-muted">联系客服</a></li>
                </ul>
            </div>
            <div class="col-2">
                <h6 class="text-center">支付方式</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">网上支付</a></li>
                    <li class="text-center"><a href="" class="text-muted">礼品卡支付</a></li>
                    <li class="text-center"><a href="" class="text-muted">货到付款</a></li>
                </ul>
            </div>
            <div class="col-2">
                <h6 class="text-center">配送方式</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">上门自提</a></li>
                    <li class="text-center"><a href="" class="text-muted">配送到家</a></li>
                    <li class="text-center"><a href="" class="text-muted">限时达</a></li>
                    <li class="text-center"><a href="" class="text-muted">海外配送</a></li>
                </ul>
            </div>
            <div class="col-2">
                <h6 class="text-center">售后服务</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">售后政策</a></li>
                    <li class="text-center"><a href="" class="text-muted">退款说明</a></li>
                    <li class="text-center"><a href="" class="text-muted">价格保护</a></li>
                    <li class="text-center"><a href="" class="text-muted">退/换货</a></li>
                    <li class="text-center"><a href="" class="text-muted">取消订单</a></li>
                </ul>
            </div>
            <div class="col-2">
                <h6 class="text-center">商家服务</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">商家中心</a></li>
                    <li class="text-center"><a href="" class="text-muted">运营服务</a></li>
                </ul>
            </div>
            <div class="col-2">
                <h6 class="text-center">特色服务</h6>
                <ul class="list-unstyled">
                    <li class="text-center"><a href="" class="text-muted">二手书商城</a></li>
                    <li class="text-center"><a href="" class="text-muted">图书交流论坛</a></li>
                    <li class="text-center"><a href="" class="text-muted">图书发布会</a></li>
                </ul>
            </div>
        </div>
        <!-- 版权信息-->
        <div class="text-center">©2017 达内集团有限公司 版权所有 京ICP证xxxxxxxxxxx</div>
    </footer>
</div>
</body>
</html>